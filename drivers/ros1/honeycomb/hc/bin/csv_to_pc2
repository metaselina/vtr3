#! /usr/bin/env python

# Unpublished Work Copyright 2019 Waymo LLC. All rights reserved.
# Waymo Proprietary and Confidential - Contains Trade Secrets

import csv
import sys

import rosbag
import sensor_msgs.point_cloud2 as pc2
from sensor_msgs.msg import PointField
from std_msgs.msg import Header

def ConvertCsvToPc2Bag(csvfile, bagfile):
  with open(csvfile) as f:
    reader = csv.reader(f)
    fieldnames = reader.next()
    fields = [
        PointField(n, i * 4, PointField.FLOAT32, 1)
        for i, n in enumerate(fieldnames)
    ]
    points = []
    for row in reader:
      points.append((float(x) for x in row))
  header = Header()
  header.frame_id = 'world'
  point_cloud = pc2.create_cloud(header, fields, points)

  bag = rosbag.Bag(bagfile, 'w')
  bag.write('points', point_cloud)
  bag.close()


def main(argv):
  if len(argv) != 3:
    sys.stderr.write('Invalid number of arguments:\n')
    sys.stderr.write('Usage: %s <csv filename> <bag filename>\n' % argv[0])
    sys.exit(1)
  ConvertCsvToPc2Bag(argv[1], argv[2])

if __name__ == "__main__":
  main(sys.argv)
