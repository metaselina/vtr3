#! /usr/bin/env python

# Unpublished Work Copyright 2019 Waymo LLC. All rights reserved.
# Waymo Proprietary and Confidential - Contains Trade Secrets

import rosbag
import sensor_msgs.point_cloud2
import sys

def ConvertPc2BagToCsv(bagfile):
  bag = rosbag.Bag(bagfile)
  messages = bag.read_messages('/points')
  for i, (topic, message, t) in enumerate(messages):
    if i == 0:
      fields = [f.name for f in message.fields]
      print 'timestamp,' + ','.join(fields)
    points = sensor_msgs.point_cloud2.read_points(message)
    for point in points:
      print '%s,' % t + ','.join("%s" % v for v in point)

def main(argv):
  if len(argv) != 2:
    sys.stderr.write('Invalid number of arguments:\n')
    sys.stderr.write('Usage: %s <bag filename>\n' % argv[0])
    sys.exit(1)
  ConvertPc2BagToCsv(argv[1])

if __name__ == "__main__":
  main(sys.argv)
